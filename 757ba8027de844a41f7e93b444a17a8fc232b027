{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "0e4ea84a_34765257",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1002072
      },
      "writtenOn": "2022-03-24T16:30:33Z",
      "side": 1,
      "message": "I am going to roll this CL into ",
      "revId": "757ba8027de844a41f7e93b444a17a8fc232b027",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a1e90add_ecd7a525",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1002072
      },
      "writtenOn": "2022-03-24T16:30:53Z",
      "side": 1,
      "message": "Oops, I was thinking of joining the 2 CLs but I changed my mind.",
      "parentUuid": "0e4ea84a_34765257",
      "revId": "757ba8027de844a41f7e93b444a17a8fc232b027",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6dc54d32_03892038",
        "filename": "src/gn/target.cc",
        "patchSetId": 4
      },
      "lineNbr": 815,
      "author": {
        "id": 1000067
      },
      "writtenOn": "2022-03-23T19:38:09Z",
      "side": 1,
      "message": "WYI, there is a *really* *ugly* bug on this line which should use `dep-\u003erust_transitive_inheritable_libs_.GetOrderedAndPublicFlag()` instead of reusing the value for the current target.\n\nThis means that a statement like:\n\n```\n  executable(\"rustbin\") {\n    crate_name \u003d \"...\"\n    deps \u003d [\n      \":some_shared_library\",\n      \":some_rust_library\",\n    ]\n  }\n```\n\nWould pull all source sets that the shared library depends on into the binary itself (because on the second pass, the code above mistakenly thinks that the rust library depends on them too). It took me days to debug this :-( And the fix is only 4 characters long. This fixes some of the Fuchsia build breaks, but not all of them.\n\nEven if I fix that, I still have a problem with the following:\n\n```\nexecutable(\"rustbin\") {\n  crate_name \u003d \"...\"\n  deps \u003d [ \":rustlib\" ]\n}\n\nrust_library(\"rustlib\") {\n  ...\n  deps \u003d [ \":shared_lib\" ]\n}\n\nshared_library(\"shared_lib\") {\n  deps \u003d [ \":source_lib\" ]\n}\n\nsource_set(\"source_lib\") {\n  sources \u003d [ \"lib.cc\" ]\n}\n```\n\nWhen I use this, the object files of the source set are pushed to the link command of the rust binary incorrectly. I don\u0027t understand why, but this is a direct consequence of the current CL (without it, the problem does not occur).",
      "revId": "757ba8027de844a41f7e93b444a17a8fc232b027",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1979b8dd_ce119b68",
        "filename": "src/gn/target.cc",
        "patchSetId": 4
      },
      "lineNbr": 815,
      "author": {
        "id": 1002072
      },
      "writtenOn": "2022-03-24T14:14:25Z",
      "side": 1,
      "message": "Thanks David. Fixing this changes the output in exactly 0 unit tests at the moment. I will address it in another CL.",
      "parentUuid": "6dc54d32_03892038",
      "revId": "757ba8027de844a41f7e93b444a17a8fc232b027",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "72352e87_bfef87fd",
        "filename": "src/gn/target.cc",
        "patchSetId": 4
      },
      "lineNbr": 815,
      "author": {
        "id": 1002072
      },
      "writtenOn": "2022-03-24T15:11:41Z",
      "side": 1,
      "message": "I\u0027ll take the 2nd one back to the bug.",
      "parentUuid": "1979b8dd_ce119b68",
      "revId": "757ba8027de844a41f7e93b444a17a8fc232b027",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "98211700_1d72a586",
        "filename": "src/gn/target.cc",
        "patchSetId": 4
      },
      "lineNbr": 815,
      "author": {
        "id": 1002072
      },
      "writtenOn": "2022-03-24T15:15:33Z",
      "side": 1,
      "message": "Oh I see this repro for me with this CL applied too.\n```\nsource_set(\"c_inner_set\") {\n  sources \u003d [ \"c_inner_set.c\" ]\n}\n\nshared_library(\"c_so\") {\n  deps \u003d [\n    \":c_inner_set\",\n  ]\n}\n\nrust_library(\"rust_lib\") {\n  crate_root \u003d \"rust_lib.rs\"\n  sources \u003d [ \"rust_lib.rs\" ]\n  deps \u003d [ \":c_so\" ]\n}\n\nexecutable(\"rsexe\") {\n  sources \u003d [ \"exe.rs\" ]\n  deps \u003d [ \":rust_lib\" ]\n}\n```\n```\n[5/5] rustc -Clink-arg\u003d-v --crate-name rsexe ../exe.rs --crate-type bin --emit\u003ddep-info\u003dobj/rsexe.d,link -Z dep-info-omit-d-target  -o obj/rsexe -Ldependency\u003dobj -Lnative\u003dobj -Lnative\u003d. -Clink-arg\u003d-Bdynamic -Clink-arg\u003dobj/c_inner_set.c_inner_set.o -Clink-arg\u003d./libc_so.so -ldl -lpthread -lrt --extern rust_lib\u003dobj/librust_lib.rlib\n```\nI think it _is_ correct to forward rlibs through the source_set(), but it\u0027s poking at another bug. Investigating.",
      "parentUuid": "72352e87_bfef87fd",
      "revId": "757ba8027de844a41f7e93b444a17a8fc232b027",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "48cc680c_f7bdf713",
        "filename": "src/gn/target.cc",
        "patchSetId": 4
      },
      "lineNbr": 815,
      "author": {
        "id": 1002072
      },
      "writtenOn": "2022-03-24T16:30:33Z",
      "side": 1,
      "message": "Ok so this CL\u0027s test fails when I apply it on top of https://gn-review.googlesource.com/c/gn/+/13180.\n\nThat CL removes the blanket propagation of all C libs behind a Rust lib. But it also stopped propagating rlibs to the linker, so it went too far.\n\nWhen I fix that, and apply both CLs, then I don\u0027t see the source_sets going wrong anymore as above.\n\nI will add a test to the https://gn-review.googlesource.com/c/gn/+/13180 CL and fix that issue there.",
      "parentUuid": "98211700_1d72a586",
      "revId": "757ba8027de844a41f7e93b444a17a8fc232b027",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "271a9e9a_46c7d055",
        "filename": "src/gn/target.cc",
        "patchSetId": 4
      },
      "lineNbr": 815,
      "author": {
        "id": 1002072
      },
      "writtenOn": "2022-03-24T17:52:53Z",
      "side": 1,
      "message": "I have applied said fix at https://gn-review.googlesource.com/c/gn/+/13180/12..14 and rebased this CL on top of it. Now I get:\n```\n[5/5] rustc -Clink-arg\u003d-v --crate-name rsexe ../exe.rs --crate-type bin --emit\u003ddep-info\u003dobj/rsexe.d,link -Z dep-info-omit-d-target  -o obj/rsexe -Ldependency\u003dobj -Lnative\u003d. -Clink-arg\u003d-Bdynamic -Clink-arg\u003d./libc_so.so -ldl -lpthread -lrt --extern rust_lib\u003dobj/librust_lib.rlib\n```\n\nc_inner_set.c_inner_set.o no longer appears after this change.",
      "parentUuid": "48cc680c_f7bdf713",
      "revId": "757ba8027de844a41f7e93b444a17a8fc232b027",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    }
  ]
}