{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "a0dd24c5_b5d0c59b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000633
      },
      "writtenOn": "2020-10-20T16:33:29Z",
      "side": 1,
      "message": "This CL differs from Petr\u0027s CL in a few ways:\n\n  * This is stripped down to just the restat portion. clean_stale is a separate CL\n  * We only have the command-line switch for --ninja-executable, but we will also attempt to fall back to a ninja binary in the path. This was based on Brett\u0027s comment in the previous CL.\n  * We run the ninja binary to determine the version instead of relying on the build configuration\u0027s required version. I worry about relying on the ninja output, but it means the subset of users that don\u0027t require 1.10, but actually use it can benefit from the restat.",
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "521d81cb_edaf9ea3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000633
      },
      "writtenOn": "2020-11-09T19:48:13Z",
      "side": 1,
      "message": "Gentle ping on this CL. Any concerns with adding the restat?",
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0ca5b6ff_24657f1f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000014
      },
      "writtenOn": "2020-11-09T19:53:04Z",
      "side": 1,
      "message": "Thanks for the ping, sorry.",
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e19aca2_11f2f65e",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 366,
      "author": {
        "id": 1000014
      },
      "writtenOn": "2020-11-09T19:53:04Z",
      "side": 1,
      "message": "Do you know how much this slows down GN for a gen run? I\u0027m especially worried about Windows.\n\nWe have ninja_required_version in the .gn file. Can we use that value instead of running GN? The reason against would be that maybe I have the new version of Ninja installed but the current project doesn\u0027t require it. But Chrome uses an older Ninja and it won\u0027t work with the new one, and Fuchsia uses the newer one and I don\u0027t think it works with the older one. I suspect at least across the versions we\u0027re talking about, Ninja isn\u0027t very compatible. So that maybe indicates this reason against just using the required version isn\u0027t important.",
      "range": {
        "startLine": 366,
        "startChar": 41,
        "endLine": 366,
        "endChar": 56
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a8554bdb_96e498ce",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 366,
      "author": {
        "id": 1000014
      },
      "writtenOn": "2020-11-09T21:47:31Z",
      "side": 1,
      "message": "I meant \"instead of running Ninja\" in 2nd line.",
      "parentUuid": "6e19aca2_11f2f65e",
      "range": {
        "startLine": 366,
        "startChar": 41,
        "endLine": 366,
        "endChar": 56
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "61b9f9c3_dbef680e",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 366,
      "author": {
        "id": 1000633
      },
      "writtenOn": "2020-11-10T17:31:06Z",
      "side": 1,
      "message": "I found the version check to have a fairly negligible impact on my machine, but that\u0027s probably not very representative of the general user. FWIW, running gn gen on example/simple_build indicated that the version check cost about 2ms. On a fuchsia build, it was entirely in the noise. \n\nI would definitely agree that different versions of ninja do not play nicely with one another. I tried running some of the tools using a ninja 1.10 binary on a Chromium build, and found they could create some breakage. Cleandead failed due to ninja deps file format changes. A restat on build.ninja seemingly succeeded, but it introduced a higher resolution timestamp into the build log, which then resulted in a re-gen on next ninja run. \n\nGiven this, is it still reasonable to fall back to using ninja from the PATH? My concern is projects that provide an in-tree prebuilt ninja conflicting with a ninja in the user\u0027s PATH. This could lead to some subtle breakage.",
      "parentUuid": "a8554bdb_96e498ce",
      "range": {
        "startLine": 366,
        "startChar": 41,
        "endLine": 366,
        "endChar": 56
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "49c97287_fb895acb",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 366,
      "author": {
        "id": 1000014
      },
      "writtenOn": "2020-11-10T19:27:18Z",
      "side": 1,
      "message": "I\u0027m now thinking you\u0027re right and we should only do this if ninja is specified. The ninja on my path is from Chromium which causes me problems sometimes. And I feel like in Fuchsia \"fx gn gen out/x64\" should work, but with the current patch this will cause version skew. Better to avoid running ninja in that case and living with the unnecessary re-gen.",
      "parentUuid": "61b9f9c3_dbef680e",
      "range": {
        "startLine": 366,
        "startChar": 41,
        "endLine": 366,
        "endChar": 56
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "565e7f56_cfb8d9ac",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 366,
      "author": {
        "id": 1000633
      },
      "writtenOn": "2020-11-13T22:34:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "49c97287_fb895acb",
      "range": {
        "startLine": 366,
        "startChar": 41,
        "endLine": 366,
        "endChar": 56
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1386beb4_5ac2d6c1",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 366,
      "author": {
        "id": 1000047
      },
      "writtenOn": "2020-11-16T07:42:51Z",
      "side": 1,
      "message": "If I can chime in from the sidelines, I don\u0027t think gating this strictly on ninja_required_version is 100% correct. That\u0027s fundamentally the minimum required version, and the fact that the Chromium build has some issues with newer ninja in some circumstances is not inherent to gn.\n\nWhile switching between distant-enough ninja versions is quite destructive (requires a re-gen), I believe even in Chromium it\u0027s actually quite alright to just use newer ninja, at least in the Linux build. I\u0027ve been doing that without any issues on a linux-only fork, for quite a while now, but granted, in a limited fashion. Precise info on what breaks with the newer ninja is a bit scarce and I wasn\u0027t intentionally looking to break things.\n\nI think gn should work well with projects that specify a conservative min ninja version and are fine with newer versions. IIRC that\u0027s the route cmake took with this, accepting the version check overhead, because the redundant-regen behavior is far more noticeable. Perhaps this is version check can be acceptable if it happens only on explicit gn gen and not regen, per the other comment thread?",
      "parentUuid": "565e7f56_cfb8d9ac",
      "range": {
        "startLine": 366,
        "startChar": 41,
        "endLine": 366,
        "endChar": 56
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "dba57d40_63e46491",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 366,
      "author": {
        "id": 1000633
      },
      "writtenOn": "2020-11-20T20:40:09Z",
      "side": 1,
      "message": "While testing the previous patchset with Chromium, I found that using 1.10 ninja to run restat inserted a higher resolution timestamp into the .ninja_log for build.ninja. On the next ninja(1.8) build run, this timestamp was seemingly ignored and another re-gen was triggered, thus nullifying the benefit of the restat. I would guess that if the build execution ninja was 1.9 (when high resolution timestamps were introduced), that restat would work, but I have not confirmed.\n\nI think the root of my concern is ensuring that the ninja version used for \u0027tool\u0027 execution is the same as the version used for \u0027build\u0027 execution. If there is a mismatch between those two, we could create weird ping pong behavior, where the \u0027tool\u0027 execution writes the .ninja_log in one format and then the \u0027build\u0027 execution writes it in another format. Since the ninja used for \u0027build\u0027 execution is unknown to GN, I was concerned this could be a potential foot gun for users. \n\nIf it is reasonable to say \"if --ninja-executable doesn\u0027t match the ninja used for builds, things might break in odd ways\", then I think we could help some of those projects that have a conservative min version but use a newer version at runtime. However, I would also point out that the documentation for \u0027ninja_required_version\u0027 does encourage users to specify newer versions to benefit from additional optimizations.",
      "parentUuid": "1386beb4_5ac2d6c1",
      "range": {
        "startLine": 366,
        "startChar": 41,
        "endLine": 366,
        "endChar": 56
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c95d8ebd_fa321675",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 366,
      "author": {
        "id": 1000047
      },
      "writtenOn": "2020-11-23T07:43:28Z",
      "side": 1,
      "message": "I see how things could get \u0027interesting\u0027 if someone carefully uses a non-default ninja to build one project, and gn has no way of knowing at initial gn gen time what that ninja would be. Perhaps \u0027do this if ninja is specified OR when ninja_required_version is large enough\u0027 would be agreeable? We can probably assume that if someone passes the actual ninja version they will be careful enough not to mix and match (switching ninja versions that are distant enough clobbers the entire build with \"ninja: warning: bad deps log signature or version; starting over).",
      "parentUuid": "dba57d40_63e46491",
      "range": {
        "startLine": 366,
        "startChar": 41,
        "endLine": 366,
        "endChar": 56
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c0023ad6_e9f71a3e",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 373,
      "author": {
        "id": 1000633
      },
      "writtenOn": "2020-11-10T17:31:06Z",
      "side": 1,
      "message": "It is probably worth considering skipping this restat step when we\u0027re doing a re-gen. On a re-gen, ninja is going to restat build.ninja anyways, so this step becomes redundant. We could add a --regeneration switch to be included in the re-gen command that we could rely on to elide the restat.",
      "range": {
        "startLine": 373,
        "startChar": 8,
        "endLine": 373,
        "endChar": 30
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "617176fd_0e44d082",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 373,
      "author": {
        "id": 1000014
      },
      "writtenOn": "2020-11-10T19:27:18Z",
      "side": 1,
      "message": "Skipping the restat on re-gen sounds very good, it would eliminate any concerns I have about performance.",
      "parentUuid": "c0023ad6_e9f71a3e",
      "range": {
        "startLine": 373,
        "startChar": 8,
        "endLine": 373,
        "endChar": 30
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0b77ad42_ae6fc789",
        "filename": "src/gn/command_gen.cc",
        "patchSetId": 2
      },
      "lineNbr": 373,
      "author": {
        "id": 1000633
      },
      "writtenOn": "2020-11-13T22:34:49Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "617176fd_0e44d082",
      "range": {
        "startLine": 373,
        "startChar": 8,
        "endLine": 373,
        "endChar": 30
      },
      "revId": "0a78191f78eb6e84b5a2e7d23076bec4a66b7369",
      "serverId": "c360c8e5-7aa8-3905-a7a0-810934766dac"
    }
  ]
}